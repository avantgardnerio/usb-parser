<html>
    <head>
        <title>USB Descriptor Parser</title>
        <style>
            /* Remove default bullets */
            ul, #myUL {
                list-style-type: none;
            }

            /* Remove margins and padding from the parent ul */
            #myUL {
                margin: 0;
                padding: 0;
            }

            /* Style the caret/arrow */
            .caret {
                cursor: pointer;
                user-select: none; /* Prevent text selection */
            }

            /* Create the caret/arrow with a unicode, and style it */
            .caret::before {
                content: "\25B6";
                color: black;
                display: inline-block;
                margin-right: 6px;
            }

            /* Rotate the caret/arrow icon when clicked on (using JavaScript) */
            .caret-down::before {
                transform: rotate(90deg);
            }

            /* Hide the nested list */
            .nested {
                display: block;
            }

            /* Show the nested list when the user clicks on the caret/arrow (with JavaScript) */
            .active {
                display: block;
            }
        </style>
        <script>
            const parseTree = (arrayBuffer) => {
                const node = new TreeNode()
                let index = 0
                const dataView = new DataView(arrayBuffer)
                while(index < arrayBuffer.byteLength) {
                    const size = dataView.getUint8(index)
                    const type = dataView.getUint8(index + 1)
                    const byteArr = arrayBuffer.slice(index, index + size)

                    const child = descriptorFactory(type, byteArr)
                    node.children.push(child)
                    console.log(child.toString())

                    index += size
                }
                console.log(`made ${node.children.length} children`)
                return node
            }
            
            class TreeNode {
                constructor() {
                    this.children = []
                }
            }

            class UsbDescriptor extends TreeNode {
                constructor(byteArr) {
                    super()
                    this.byteArr = byteArr
                    this.dataView = new DataView(this.byteArr)
                }
                get type() {
                    return this.dataView.getUint8(0)
                }
                get typeName() {
                    return descTypeMap(this.type)
                }
                toString() {
                    return `Unknown Descriptor type=${this.type} size=${this.byteArr.byteLength}`
                }
            }

            class DeviceDescriptor extends UsbDescriptor {
                constructor(byteArr) {
                    super(byteArr)
                }
                get maxPower() {
                    return `${this.dataView.getUint8(8) * 2}ma`;
                }
                toString() {
                    return `DeviceDescriptor maxPower=${this.maxPower}`
                }
            }

            const descriptorFactory = (type, byteArr) => {
                if (descTypeMap[type] === 'USB_DT_DEVICE') {
                    return new DeviceDescriptor(byteArr)
                } else {
                    return new UsbDescriptor(byteArr)
                }
            }
            const descTypeMap = {
                '1': 'USB_DT_DEVICE',
                '2': 'USB_DT_CONFIG',
                '4': 'USB_DT_INTERFACE',
                '5': 'USB_DT_ENDPOINT',
                '11': 'USB_DT_INTERFACE_ASSOCIATION',
                '36': 'USB_DT_CS_INTERFACE',
                '48': 'USB_DT_SS_ENDPOINT_COMP',
            };
            const parseUsbDescriptor = (buffer, pos) => {
                const u8 = new Uint8Array(buffer, pos, 2);
                return {
                    name: `${descTypeMap[u8[1]] || `Unknown (${u8[1]})`} ${u8[0]}`,
                    bLength: u8[0],
                    bDescriptorType: u8[1],
                    children: [],
                }
            }
            const parseFile = (arrayBuffer) => {
                // TODO: parse
                const root = parseTree(arrayBuffer)
            };
            const onRead = (e) => {
                const arrayBuffer = e.target.result;
                const root = parseFile(arrayBuffer);
            }
            const readSingleFile = (e) => {
                var file = e.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = onRead;
                reader.readAsArrayBuffer(file);
            };
            onload = () => {
                const fpMain = document.getElementById('fpMain');
                fpMain.addEventListener('change', readSingleFile, false);
            }
        </script>
    </head>
    <body>
        Select a binary USB descriptor file:
        <input type="file" id="fpMain" />
    </body>
</html>